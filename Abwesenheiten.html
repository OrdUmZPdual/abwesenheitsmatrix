<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Anwesenheitsmatrix</title>
  <style>
body {
  display: flex;
  flex-direction: column;
  height: 100vh;
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background-color: #f7f9fc;
  color: #333;
}

/* Kopf und Fu√ü fixieren */
header, footer {
  flex: 0 0 auto;
  background: #fff;
  padding: 10px 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  z-index: 10;
}

/* Scrollbarer Mittelteil */
main {
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 20px;
  background: #fff;
}

/* Tabelle */
#absenceTable {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;
  min-width: 600px;
}

#absenceTable th,
#absenceTable td {
  border: 1px solid #ddd;
  text-align: center;
  padding: 4px;
  min-width: 28px;
  font-size: 0.8em;
  background: #fff;
}

/* Kopfzeile bleibt beim Scrollen sichtbar */
#absenceTable thead th {
  position: sticky;
  top: 0;
  background: #f8f8f8;
  z-index: 2;
  box-shadow: 0 2px 2px rgba(0,0,0,0.05);
}

/* Namensspalte fixieren */
.name-cell {
  position: sticky;
  left: 0;
  background: #fdfdfd;
  z-index: 3;
  text-align: left;
  width: 200px;
  font-size: 0.85em;
  line-height: 1.2;
  white-space: normal;
}

/* Ecke oben links */
.name-cell:first-child {
  z-index: 4;
  background-color: #f0f0f0;
}

/* Buttons */
.button-bar button,
.form-area button,
#saveButton {
  margin-right: 8px;
  padding: 6px 12px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background-color: #e3eaf2;
  border-radius: 6px;
  transition: background-color 0.2s ease;
}

.button-bar button:hover,
.form-area button:hover,
#saveButton:hover {
  background-color: #c9d6e3;
}

/* Legende */
.legend-toggle { margin-bottom: 10px; }
.legend-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75em;
  margin-bottom: 10px;
}
.legend-table th, .legend-table td {
  border: 1px solid #ccc;
  padding: 4px 6px;
  text-align: left;
}
.legend-hidden { display: none; }

/* Formular unten */
.form-area {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.form-area input {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  flex: 1;
}
.form-area button,
#saveButton {
  padding: 6px 12px;
  background-color: #2c89d9;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.form-area button:hover,
#saveButton:hover {
  background-color: #1f6fb4;
}

/* Wochenenden */
.weekend {
  background-color: #eee !important;
  color: #999;
  pointer-events: none;
}

.selected {
  background-color: #eaf6ff !important; /* sehr helles, freundliches Blau */
}

/*K/Ko/EDK rot f√§rben*/
.critical {
  background-color: #f8d7da !important; /* hellrot */
  color: #a94442;                       /* dunkler Rotton */
  font-weight: bold;
}

header, footer {
  background: linear-gradient(90deg, #2c89d9, #5aa9e6);
  color: white;
  padding: 15px 25px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
header h2, footer h2 {
  margin: 0;
}

.button-bar button,
.form-area button,
#saveButton {
  background: #2c89d9;
  color: white;
  border-radius: 6px;
  padding: 8px 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}

.button-bar button:hover,
.form-area button:hover,
#saveButton:hover {
  background: #1f6fb4;
  transform: translateY(-2px);
}

.delete-btn {
  margin-left: 8px;
  color: #d9534f;
  cursor: pointer;
  font-size: 0.9em;
  transition: color 0.2s ease;
}
.delete-btn:hover {
  color: #b52b27;
}	  

/* Namensspalte linksb√ºndig */
.name-cell {
  text-align: left !important;
  padding-left: 8px;   /* etwas Abstand vom Rand */
  font-weight: 500;    /* optional: etwas kr√§ftiger */
}
	  
  </style>
</head>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Anwesenheitsmatrix</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h2>Anwesenheitsmatrix ‚Äì <span id="monatLabel"></span> <span id="bereichLabel"></span></h2>
    <h2 id="bereichAnzeige" style="margin-top: 5px; color: #555;"></h2>

    <div id="zurueckContainer"></div>

    <div class="month-select">
      <label for="monthSelect"><strong>Monat ausw√§hlen:</strong></label>
      <select id="monthSelect"></select>
    </div>

    <div class="button-bar" id="buttonBar"></div>

    <div class="legend-toggle">
      <button onclick="toggleLegende()">üõà Legende anzeigen</button>
    </div>

    <div id="legendeBox" class="legend-hidden">
      <table class="legend-table" id="legendenTabelle">
        <thead>
          <tr>
            <th>Abk√ºrzung</th><th>Bedeutung</th>
            <th>Abk√ºrzung</th><th>Bedeutung</th>
            <th>Abk√ºrzung</th><th>Bedeutung</th>
          </tr>
        </thead>
        <tbody id="legendenBody"></tbody>
      </table>
    </div>
  </header>

  <main>
    <table id="absenceTable">
      <thead>
        <tr>
          <th class="name-cell">Mitarbeiter</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <div class="form-area" id="formArea">
      <input type="text" id="vorname" placeholder="Vorname" />
      <input type="text" id="nachname" placeholder="Nachname" />
      <button onclick="addMitarbeiter()">Hinzuf√ºgen</button>
      <button id="saveButton" onclick="saveData()">üíæ Speichern & Schlie√üen</button>
    </div>
  </footer>
</body>

<script>
  const kuerzelLegende = [
    { code: "K", text: "Krank mit Attest" },
    { code: "Ko", text: "Krank ohne Attest" },
    { code: "a", text: "Anwesend" },
    { code: "U", text: "Urlaub" },
    { code: "SU", text: "Sonderurlaub" },
    { code: "AA", text: "Arbeitsabbruch" },
    { code: "EDK", text: "Erkrankung d. Kindes" },
    { code: "√ú", text: "√úberstunden/Zeit.ausgl." },
    { code: "TZ", text: "Regelfrei/Teilzeit" },
    { code: "MU", text: "Mutterschutz" },
    { code: "EZ", text: "Elternzeit" },
    { code: "AU", text: "Arbeitsunfall" },
    { code: "REH", text: "Reha/Kur" },
    { code: "HM", text: "Hamburger Modell" },
    { code: "AZK", text: "Arbeitszeitkonto" },
    { code: "FU", text: "Fehlt unentschuldigt" },
    { code: "BV", text: "Besch√§ftigtenvertretung" },
	{ code: "DR", text: "Dienstreise" }
  ];

  const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni",
                      "Juli", "August", "September", "Oktober", "November", "Dezember"];

const selectedCells = new Set();
let isMouseDown = false;
let dragRow = null;
let dragCol = null;
let dragDirection = null; // "row" oder "col"

  const urlParams = new URLSearchParams(window.location.search);
  const bereich = urlParams.get("bereich") || "pflege";
  const monatParam = urlParams.get("monat");
  const now = new Date();
  const aktuellerMonat = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  const monat = monatParam || aktuellerMonat;
  const isReadonly = monat < aktuellerMonat;

  const [jahr, monatIndex] = monat.split("-");
  const letzterTag = new Date(jahr, monatIndex, 0).getDate();

  document.getElementById("monatLabel").textContent = `${monthNames[parseInt(monatIndex, 10) - 1]} ${jahr}`;
  document.getElementById("bereichLabel").textContent = `(${bereich})`;

  const container = document.querySelector("main");
  if (isReadonly) container.classList.add("readonly");

  function toggleLegende() {
    const box = document.getElementById("legendeBox");
    const btn = document.querySelector(".legend-toggle button");
    box.classList.toggle("legend-hidden");
    btn.textContent = box.classList.contains("legend-hidden") ? "üõà Legende anzeigen" : "üõà Legende ausblenden";
  }

  function buildMonthSelect() {
    const select = document.getElementById("monthSelect");
    const heute = new Date();
    for (let i = 0; i <= 1; i++) {
      const d = new Date(heute.getFullYear(), heute.getMonth() - i, 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const value = `${y}-${m}`;
      const option = document.createElement("option");
      option.value = value;
      option.textContent = `${monthNames[d.getMonth()]} ${y}`;
      if (value === monat) option.selected = true;
      select.appendChild(option);
    }

    select.addEventListener("change", () => {
      const newMonat = select.value;
      const url = new URL(window.location.href);
      url.searchParams.set("monat", newMonat);
      window.location.href = url.toString();
    });
  }

  const table = document.getElementById("absenceTable");
  const theadRow = table.querySelector("thead tr");
  const tbody = table.querySelector("tbody");

  for (let tag = 1; tag <= letzterTag; tag++) {
  const date = new Date(jahr, parseInt(monatIndex) - 1, tag);
  const th = document.createElement("th");
  th.textContent = String(tag).padStart(2, "0");

  if (date.getDay() === 0 || date.getDay() === 6) {
    th.classList.add("weekend");
  }

  theadRow.appendChild(th);
}

  function createRow(vorname, nachname, daten = {}) {
    const nameHTML = `${nachname},<br>${vorname}`;
    const fullName = `${nachname}, ${vorname}`;
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.className = "name-cell";
    tdName.dataset.name = fullName;
    tdName.innerHTML = nameHTML;

    const del = document.createElement("span");
    del.textContent = "‚úñ";
    del.className = "delete-btn";
    del.title = "Mitarbeiter entfernen";
    del.onclick = () => {
      if (!isReadonly && confirm(`M√∂chten Sie ${fullName} wirklich aus der Liste entfernen?`)) {
        tr.remove();
      }
    };

    tdName.appendChild(del);
    tr.appendChild(tdName);

    for (let tag = 1; tag <= letzterTag; tag++) {
  const td = document.createElement("td");
  td.dataset.tag = tag;
  td.dataset.name = fullName;

  const date = new Date(jahr, parseInt(monatIndex) - 1, tag);
  const isWeekend = date.getDay() === 0 || date.getDay() === 6;

  if (isWeekend) {
    td.classList.add("weekend");
  }

  if (daten[tag]) {
	td.textContent = daten[tag];
		if (["K", "Ko", "EDK"].includes(daten[tag])) {
			td.classList.add("critical");
		}
	}

  if (!isReadonly && !isWeekend) {
  td.addEventListener("mousedown", (e) => {
    e.preventDefault();
    isMouseDown = true;
    dragRow = td.parentElement;
    dragCol = td.cellIndex;
    dragDirection = null; // Richtung wird erst beim Ziehen festgelegt
    toggleCell(td, e.ctrlKey);
  });

  td.addEventListener("mouseover", () => {
    if (isMouseDown) {
      if (!dragDirection) {
        if (td.parentElement === dragRow) {
          dragDirection = "row";
        } else if (td.cellIndex === dragCol) {
          dragDirection = "col";
        }
      }

      if (dragDirection === "row" && td.parentElement === dragRow) {
        toggleCell(td, true);
      } else if (dragDirection === "col" && td.cellIndex === dragCol) {
        toggleCell(td, true);
      }
    }
  });

  td.addEventListener("mouseup", () => {
    isMouseDown = false;
    dragRow = null;
    dragCol = null;
    dragDirection = null;
  });
}

  tr.appendChild(td);
}

    tbody.appendChild(tr);
  }
  document.body.addEventListener("mouseup", () => {
  isMouseDown = false;
  dragRow = null;
  dragCol = null;
  dragDirection = null;
});

  function toggleCell(td, allowMulti) {
    if (!allowMulti) {
      selectedCells.forEach(cell => cell.classList.remove("selected"));
      selectedCells.clear();
    }
    if (!selectedCells.has(td)) {
      td.classList.add("selected");
      selectedCells.add(td);
    }
  }

  function addMitarbeiter() {
    if (isReadonly) return;
    const vn = document.getElementById("vorname").value.trim();
    const nn = document.getElementById("nachname").value.trim();
    if (vn && nn) {
      createRow(vn, nn);
	  sortTable();
      document.getElementById("vorname").value = "";
      document.getElementById("nachname").value = "";
    } else {
      alert("Bitte Vor- und Nachnamen eingeben.");
    }
  }

  function saveData() {
    if (isReadonly) return;
    const rows = [...tbody.querySelectorAll("tr")];
    const data = {};

    rows.forEach(row => {
      const name = row.querySelector("td").dataset.name;
      const tage = row.querySelectorAll("td:not(.name-cell)");
      const eintraege = {};

      tage.forEach(td => {
        if (td.textContent.trim()) {
          eintraege[td.dataset.tag] = td.textContent.trim();
        }
      });

      data[name] = eintraege;
    });

    fetch(`save.php?bereich=${encodeURIComponent(bereich)}&monat=${encodeURIComponent(monat)}`, {
  method: "POST",
  body: JSON.stringify(data),
  headers: { "Content-Type": "application/json" }
})
  .then(res => res.json())
  .then(json => {
    alert("‚úÖ Anwesenheiten gespeichert!");
    datenGe√§ndert = false;
    window.close(); // Fenster schlie√üen
  })
  .catch(err => alert("‚ùå Fehler beim Speichern"));


const personFilter = urlParams.get("person");

const fetchUrl = personFilter
  ? `get.php?monat=${encodeURIComponent(monat)}&person=${encodeURIComponent(personFilter)}`
  : `get.php?bereich=${encodeURIComponent(bereich)}&monat=${encodeURIComponent(monat)}`;

fetch(fetchUrl)
  .then(res => res.json())
  .then(json => {
    if (personFilter) {
      const daten = json.daten;
      const bereichGefunden = json.bereich || "Unbekannt";

      document.getElementById("bereichAnzeige").textContent = `Bereich: ${bereichGefunden}`;

      Object.keys(daten).forEach(name => {
        const [nachname, vorname] = name.split(", ");
        createRow(vorname, nachname, daten[name]);
      });
    } else {
      document.getElementById("bereichAnzeige").textContent = `Bereich: ${bereich}`;
      
      const sortedNames = Object.keys(json).sort((a, b) => {
        const [nachA] = a.split(", ");
        const [nachB] = b.split(", ");
        return nachA.localeCompare(nachB);
      });

      sortedNames.forEach(name => {
        const [nachname, vorname] = name.split(", ");
        createRow(vorname, nachname, json[name]);
      });
    }
  });

  // K√ºrzel-Buttons erstellen
  const buttonBar = document.getElementById("buttonBar");
  kuerzelLegende.forEach(k => {
    const btn = document.createElement("button");
    btn.textContent = k.code;
    if (!isReadonly) {
      btn.addEventListener("click", () => {
		selectedCells.forEach(cell => {
		cell.textContent = k.code;
		cell.classList.remove("selected");
			if (["K", "Ko", "EDK"].includes(k.code)) {
				cell.classList.add("critical");
			} else {
				cell.classList.remove("critical");
			}
			});
		selectedCells.clear();
		});
    } else {
      btn.disabled = true;
    }
    buttonBar.appendChild(btn);
  });

  // Leeren-Button
  const leerBtn = document.createElement("button");
  leerBtn.textContent = "‚Äì";
  leerBtn.title = "Zelle leeren";
  if (!isReadonly) {
    leerBtn.addEventListener("click", () => {
      selectedCells.forEach(cell => {
        cell.textContent = "";
        cell.classList.remove("selected");
      });
      selectedCells.clear();
    });
  } else {
    leerBtn.disabled = true;
  }
  buttonBar.appendChild(leerBtn);

	const speichernBtn = document.createElement("button");
speichernBtn.textContent = "üíæ Speichern & Schlie√üen";
speichernBtn.title = "√Ñnderungen speichern und Fenster schlie√üen";
speichernBtn.style.marginLeft = "auto"; // optional: rechts ausrichten

if (!isReadonly) {
  speichernBtn.addEventListener("click", () => {
    saveData(); // ruft deine bestehende Funktion auf
  });
} else {
  speichernBtn.disabled = true;
}

buttonBar.appendChild(speichernBtn);

  // Legendentabelle aufbauen
  const legendenBody = document.getElementById("legendenBody");
  for (let i = 0; i < kuerzelLegende.length; i += 3) {
    const tr = document.createElement("tr");
    for (let j = 0; j < 3; j++) {
      const item = kuerzelLegende[i + j];
      if (item) {
        tr.innerHTML += `<td><strong>${item.code}</strong></td><td>${item.text}</td>`;
      } else {
        tr.innerHTML += `<td></td><td></td>`;
      }
    }
    legendenBody.appendChild(tr);
  }

  buildMonthSelect();
  
  let datenGe√§ndert = false;

// Sobald eine Zelle bearbeitet wird
document.addEventListener("input", () => {
  datenGe√§ndert = true;
});

// Warnung beim Schlie√üen
window.addEventListener("beforeunload", (e) => {
  if (datenGe√§ndert) {
    e.preventDefault();
    e.returnValue = ""; // Standardtext vom Browser
  }
});

// Zur√ºck-Button bei der Mitarbeiter Suche
if (personFilter) {
  const zur√ºckBtn = document.createElement("button");
  zur√ºckBtn.textContent = "üîô Zur√ºck zur Suche";
  zur√ºckBtn.title = "Zur√ºck zur Mitarbeitersuche";
  zur√ºckBtn.addEventListener("click", () => {
    window.location.href = "/OrdUm-ZP_Wiki/lib/plugins/abwesenheitsmatrix/mitarbeiter-suche.html";
  });

  document.getElementById("zurueckContainer").appendChild(zur√ºckBtn);
}
</script>

</body>

</html>



