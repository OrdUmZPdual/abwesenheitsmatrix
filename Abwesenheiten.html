<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Abwesenheitsmatrix</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f7f9fc;
      margin: 30px;
      color: #333;
    }

    h2 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 20px;
      max-width: 100%;
      overflow-x: auto;
    }

    .month-select {
      margin-bottom: 15px;
    }

    .button-bar {
      margin-bottom: 20px;
    }

    .button-bar button {
      margin-right: 8px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      background-color: #e3eaf2;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .button-bar button:hover {
      background-color: #c9d6e3;
    }

    .legend-toggle {
      margin-bottom: 10px;
    }

    .legend-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75em;
      margin-bottom: 10px;
    }

    .legend-table th, .legend-table td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }

    .legend-hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
      min-width: 600px;
    }

    th, td {
      border: 1px solid #dfe6ee;
      text-align: center;
      padding: 4px;
      height: 32px;
      user-select: none;
    }

    th {
      background-color: #ecf1f7;
      font-weight: bold;
    }

    td.name-cell {
      text-align: left;
      white-space: normal;
      width: 1%;
      font-size: 0.85em;
      line-height: 1.2;
    }

    td:not(.name-cell),
    th:not(.name-cell) {
      min-width: 24px;
      max-width: 40px;
      width: 3%;
      font-size: 0.9em;
    }

    .selected {
      background-color: #d1e6fa !important;
    }

    .delete-btn {
      color: #888;
      float: right;
      margin-left: 6px;
      font-weight: bold;
      cursor: pointer;
      visibility: hidden;
    }

    tr:hover .delete-btn {
      visibility: visible;
    }

    .form-area {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .form-area input {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
    }

    .form-area button,
    #saveButton {
      padding: 6px 12px;
      background-color: #2c89d9;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .form-area button:hover,
    #saveButton:hover {
      background-color: #1f6fb4;
    }

    .readonly td {
      background-color: #f5f5f5;
      color: #555;
    }

    .readonly .delete-btn,
    .readonly .form-area,
    .readonly #saveButton {
      display: none !important;
    }
  </style>
</head>
<body>

<h2>Abwesenheitsmatrix – <span id="monatLabel"></span> <span id="bereichLabel"></span></h2>

<div class="container" id="mainContainer">

  <div class="month-select">
    <label for="monthSelect"><strong>Monat auswählen:</strong></label>
    <select id="monthSelect"></select>
  </div>

  <div class="button-bar" id="buttonBar"></div>

  <div class="legend-toggle">
    <button onclick="toggleLegende()">🛈 Legende anzeigen</button>
  </div>

  <div id="legendeBox" class="legend-hidden">
    <table class="legend-table" id="legendenTabelle">
      <thead>
        <tr>
          <th>Abkürzung</th><th>Bedeutung</th>
          <th>Abkürzung</th><th>Bedeutung</th>
          <th>Abkürzung</th><th>Bedeutung</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <table id="absenceTable">
    <thead>
      <tr>
        <th class="name-cell">Mitarbeiter</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="form-area" id="formArea">
    <input type="text" id="vorname" placeholder="Vorname" />
    <input type="text" id="nachname" placeholder="Nachname" />
    <button onclick="addMitarbeiter()">Hinzufügen</button>
    <button id="saveButton" onclick="saveData()">💾 Speichern</button>
  </div>
</div>

<script>
  const kuerzelLegende = [
    { code: "K", text: "Krank mit Attest" },
    { code: "Ko", text: "Krank ohne Attest" },
    { code: "a", text: "Anwesend" },
    { code: "U", text: "Urlaub" },
    { code: "SU", text: "Sonderurlaub" },
    { code: "AA", text: "Arbeitsabbruch" },
    { code: "EDK", text: "Erkrankung d. Kindes" },
    { code: "Ü", text: "Überstunden/Zeit.ausgl." },
    { code: "TZ", text: "Regelfrei/Teilzeit" },
    { code: "MU", text: "Mutterschutz" },
    { code: "EZ", text: "Elternzeit" },
    { code: "AU", text: "Arbeitsunfall" },
    { code: "REH", text: "Reha/Kur" },
    { code: "HM", text: "Hamburger Modell" },
    { code: "AZK", text: "Arbeitszeitkonto" },
    { code: "FU", text: "Fehlt unentschuldigt" },
    { code: "PR", text: "Personalrat" }
  ];

  const monthNames = ["Januar", "Februar", "März", "April", "Mai", "Juni",
                      "Juli", "August", "September", "Oktober", "November", "Dezember"];

  const selectedCells = new Set();
  let isMouseDown = false;
  let dragRow = null;

  const urlParams = new URLSearchParams(window.location.search);
  const bereich = urlParams.get("bereich") || "pflege";
  const monatParam = urlParams.get("monat");
  const now = new Date();
  const aktuellerMonat = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  const monat = monatParam || aktuellerMonat;
  const isReadonly = monat < aktuellerMonat;

  const [jahr, monatIndex] = monat.split("-");
  const letzterTag = new Date(jahr, monatIndex, 0).getDate();

  document.getElementById("monatLabel").textContent = `${monthNames[parseInt(monatIndex, 10) - 1]} ${jahr}`;
  document.getElementById("bereichLabel").textContent = `(${bereich})`;

  const container = document.getElementById("mainContainer");
  if (isReadonly) container.classList.add("readonly");

  function toggleLegende() {
    const box = document.getElementById("legendeBox");
    const btn = document.querySelector(".legend-toggle button");
    box.classList.toggle("legend-hidden");
    btn.textContent = box.classList.contains("legend-hidden") ? "🛈 Legende anzeigen" : "🛈 Legende ausblenden";
  }

  function buildMonthSelect() {
    const select = document.getElementById("monthSelect");
    const heute = new Date();
    for (let i = 12; i >= 0; i--) {
      const d = new Date(heute.getFullYear(), heute.getMonth() - i, 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const value = `${y}-${m}`;
      const option = document.createElement("option");
      option.value = value;
      option.textContent = `${monthNames[d.getMonth()]} ${y}`;
      if (value === monat) option.selected = true;
      select.appendChild(option);
    }

    select.addEventListener("change", () => {
      const newMonat = select.value;
      const url = new URL(window.location.href);
      url.searchParams.set("monat", newMonat);
      window.location.href = url.toString();
    });
  }

  const table = document.getElementById("absenceTable");
  const theadRow = table.querySelector("thead tr");
  const tbody = table.querySelector("tbody");

  for (let tag = 1; tag <= letzterTag; tag++) {
    const th = document.createElement("th");
    th.textContent = String(tag).padStart(2, "0");
    theadRow.appendChild(th);
  }

  function createRow(vorname, nachname, daten = {}) {
    const nameHTML = `${nachname},<br>${vorname}`;
    const fullName = `${nachname}, ${vorname}`;
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.className = "name-cell";
    tdName.dataset.name = fullName;
    tdName.innerHTML = nameHTML;

    const del = document.createElement("span");
    del.textContent = "✖";
    del.className = "delete-btn";
    del.title = "Mitarbeiter entfernen";
    del.onclick = () => {
      if (!isReadonly && confirm(`Möchten Sie ${fullName} wirklich aus der Liste entfernen?`)) {
        tr.remove();
      }
    };

    tdName.appendChild(del);
    tr.appendChild(tdName);

    for (let tag = 1; tag <= letzterTag; tag++) {
      const td = document.createElement("td");
      td.dataset.tag = tag;
      td.dataset.name = fullName;

      if (daten[tag]) {
        td.textContent = daten[tag];
      }

      if (!isReadonly) {
        td.addEventListener("mousedown", (e) => {
          e.preventDefault();
          isMouseDown = true;
          dragRow = td.parentElement;
          toggleCell(td, e.ctrlKey);
        });

        td.addEventListener("mouseover", () => {
          if (isMouseDown && td.parentElement === dragRow) {
            toggleCell(td, true);
          }
        });

        td.addEventListener("mouseup", () => {
          isMouseDown = false;
          dragRow = null;
        });
      }

      tr.appendChild(td);
    }

    tbody.appendChild(tr);
  }

  document.body.addEventListener("mouseup", () => {
    isMouseDown = false;
    dragRow = null;
  });

  function toggleCell(td, allowMulti) {
    if (!allowMulti) {
      selectedCells.forEach(cell => cell.classList.remove("selected"));
      selectedCells.clear();
    }
    if (!selectedCells.has(td)) {
      td.classList.add("selected");
      selectedCells.add(td);
    }
  }

  function addMitarbeiter() {
    if (isReadonly) return;
    const vn = document.getElementById("vorname").value.trim();
    const nn = document.getElementById("nachname").value.trim();
    if (vn && nn) {
      createRow(vn, nn);
      document.getElementById("vorname").value = "";
      document.getElementById("nachname").value = "";
    } else {
      alert("Bitte Vor- und Nachnamen eingeben.");
    }
  }

  function saveData() {
    if (isReadonly) return;
    const rows = [...tbody.querySelectorAll("tr")];
    const data = {};

    rows.forEach(row => {
      const name = row.querySelector("td").dataset.name;
      const tage = row.querySelectorAll("td:not(.name-cell)");
      const eintraege = {};

      tage.forEach(td => {
        if (td.textContent.trim()) {
          eintraege[td.dataset.tag] = td.textContent.trim();
        }
      });

      data[name] = eintraege;
    });

    fetch(`save.php?bereich=${encodeURIComponent(bereich)}&monat=${encodeURIComponent(monat)}`, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    })
      .then(res => res.json())
      .then(json => alert("✅ Abwesenheiten gespeichert!"))
      .catch(err => alert("❌ Fehler beim Speichern"));
  }

  fetch(`get.php?bereich=${encodeURIComponent(bereich)}&monat=${encodeURIComponent(monat)}`)
    .then(res => res.json())
    .then(json => {
      for (let name in json) {
        const [nachname, vorname] = name.split(", ");
        createRow(vorname, nachname, json[name]);
      }
    });

  // Kürzel-Buttons erstellen
  const buttonBar = document.getElementById("buttonBar");
  kuerzelLegende.forEach(k => {
    const btn = document.createElement("button");
    btn.textContent = k.code;
    if (!isReadonly) {
      btn.addEventListener("click", () => {
        selectedCells.forEach(cell => {
          cell.textContent = k.code;
          cell.classList.remove("selected");
        });
        selectedCells.clear();
      });
    } else {
      btn.disabled = true;
    }
    buttonBar.appendChild(btn);
  });

  // Leeren-Button
  const leerBtn = document.createElement("button");
  leerBtn.textContent = "–";
  leerBtn.title = "Zelle leeren";
  if (!isReadonly) {
    leerBtn.addEventListener("click", () => {
      selectedCells.forEach(cell => {
        cell.textContent = "";
        cell.classList.remove("selected");
      });
      selectedCells.clear();
    });
  } else {
    leerBtn.disabled = true;
  }
  buttonBar.appendChild(leerBtn);

  // Legendentabelle aufbauen
  const tbody = document.querySelector("#legendenTabelle tbody");
  for (let i = 0; i < kuerzelLegende.length; i += 3) {
    const tr = document.createElement("tr");
    for (let j = 0; j < 3; j++) {
      const item = kuerzelLegende[i + j];
      if (item) {
        tr.innerHTML += `<td><strong>${item.code}</strong></td><td>${item.text}</td>`;
      } else {
        tr.innerHTML += `<td></td><td></td>`;
      }
    }
    tbody.appendChild(tr);
  }

  buildMonthSelect();
</script>

</body>
</html>
